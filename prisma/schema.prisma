// Lumelia SaaS - Database Schema
// Multi-tenant WhatsApp Automation Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============ TENANTS ============

model Tenant {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  businessType  String   // "beaute", "services", "ecommerce", "generic"
  businessName  String?  // Display name for the business (salon name, shop name, etc.)

  // Onboarding status
  onboardingCompleted Boolean @default(false)

  // Vertical configuration overrides (JSON)
  verticalConfig Json?   // TenantVerticalOverrides - custom templates, disabled flows, etc.

  // WhatsApp config
  whatsappNumber String?
  twilioSid      String?

  // Business info
  phone         String?
  ownerPhone    String?  // Owner's phone for notifications
  address       String?
  city          String?
  timezone      String   @default("Europe/Paris") // Timezone for date/time parsing
  businessHours String?
  services      String[] // Liste des services proposés
  pricing       String?  // Grille tarifaire

  // Subscription
  plan          String   @default("starter") // starter, pro, enterprise
  status        String   @default("trial")   // trial, active, suspended, cancelled
  trialEndsAt   DateTime?
  stripeCustomerId String?
  stripeSubscriptionId String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Assignment settings
  assignmentStrategy   String  @default("manual") // manual, round_robin, least_busy
  autoAssignOnInbound  Boolean @default(false)

  // Relations
  users         User[]
  conversations Conversation[]
  faqs          FAQ[]
  aiUsage       AIUsage[]
  contacts      Contact[]
  tags          Tag[]
  segments      Segment[]
  templates     MessageTemplate[]
  campaigns     Campaign[]
  integrations    Integration[]
  bookings        Booking[]
  resources       Resource[]
  availabilities  Availability[]
  blockedSlots    BlockedSlot[]
  waitingList     WaitingList[]
  notifications   Notification[]
  analyticsDaily   AnalyticsDaily[]
  analyticsHourly  AnalyticsHourly[]

  @@index([slug])
  @@index([status])
}

// User roles enum
enum UserRole {
  OWNER    // Full access, billing, settings
  ADMIN    // Full access except billing
  AGENT    // Inbox access, limited settings
  VIEWER   // Read-only dashboard
}

model User {
  id         String   @id @default(cuid())
  clerkId    String   @unique
  email      String   @unique
  name       String?
  role       UserRole @default(AGENT)

  // Super admin can access all tenants
  superAdmin Boolean  @default(false)

  // Agent settings
  isAvailable      Boolean @default(true)
  maxConversations Int     @default(10)

  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations
  assignedConversations Conversation[] @relation("AssignedAgent")
  notes                 ConversationNote[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([tenantId])
  @@index([clerkId])
  @@index([isAvailable])
}

// ============ CONVERSATIONS ============

model Conversation {
  id              String   @id @default(cuid())
  tenantId        String

  // Customer info
  customerPhone   String
  customerName    String?
  customerEmail   String?

  // State
  status          String   @default("active") // active, resolved, escalated, archived
  lastMessageAt   DateTime @default(now())

  // Assignment
  assignedToId    String?
  assignedTo      User?    @relation("AssignedAgent", fields: [assignedToId], references: [id])
  assignedAt      DateTime?
  priority        String   @default("normal") // low, normal, high, urgent
  tags            String[] @default([])

  // Current flow tracking (for multi-step interactions)
  currentFlow     String?  // "booking", "lead_capture", null
  currentStep     String?  // Current step in the flow
  flowData        Json?    // { service: "coupe", date: "2026-01-10", time: "14h" }

  // Lead info (captured during conversation)
  leadScore       Int?     // 0-100
  leadStatus      String?  // "new", "qualified", "converted", "lost"

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages        Message[]
  bookings        Booking[]
  notes           ConversationNote[]

  @@unique([tenantId, customerPhone])
  @@index([tenantId])
  @@index([customerPhone])
  @@index([status])
  @@index([lastMessageAt])
  @@index([assignedToId])
  @@index([priority])
  // Composite index for common query pattern: tenant + status + lastMessageAt
  @@index([tenantId, status, lastMessageAt(sort: Desc)])
  // Composite index for agent workload queries
  @@index([tenantId, assignedToId, status])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String

  // Message content
  direction      String   // "inbound", "outbound"
  content        String
  messageType    String   @default("text") // text, image, audio, template

  // AI processing
  intent         String?  // "FAQ", "BOOKING", "LEAD_CAPTURE", "ESCALATE", etc.
  confidence     Float?   // 0-1
  tierUsed       String?  // "TIER_1", "TIER_2", "TIER_3"
  faqMatchId     String?  // ID of matched FAQ if any

  // Twilio tracking
  twilioSid      String?  @unique
  status         String   @default("pending") // pending, sent, delivered, read, failed

  // Tokens & cost
  inputTokens    Int?
  outputTokens   Int?
  costUsd        Float?

  // Metadata (entities extracted, etc.)
  metadata       Json?

  createdAt      DateTime @default(now())

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([direction])
  // Composite index for message history queries
  @@index([conversationId, createdAt(sort: Desc)])
}

// ============ FAQ ============

model FAQ {
  id         String   @id @default(cuid())
  tenantId   String

  question   String
  answer     String
  keywords   String[] // Pour matching sémantique
  category   String?  // "horaires", "tarifs", "services", "adresse"

  isActive   Boolean  @default(true)
  usageCount Int      @default(0)
  lastUsedAt DateTime?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([category])
  @@index([isActive])
}

// ============ AI USAGE TRACKING ============

model AIUsage {
  id           String   @id @default(cuid())
  tenantId     String
  month        String   // "2026-01"
  model        String   // "x-ai/grok-4.1-fast", "anthropic/claude-sonnet-4.5", etc.
  tier         String   // "TIER_1", "TIER_2", "TIER_3"

  inputTokens  Int      @default(0)
  outputTokens Int      @default(0)
  requestCount Int      @default(0)
  costUsd      Float    @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month, model, tier])
  @@index([tenantId])
  @@index([month])
}

// ============ AVAILABILITY & SCHEDULING ============

model Availability {
  id           String   @id @default(cuid())
  tenantId     String

  dayOfWeek    Int      // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime    String   // "09:00"
  endTime      String   // "18:00"

  resourceId   String?  // If specific to a resource, otherwise applies to all
  resource     Resource? @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([resourceId])
  @@index([dayOfWeek])
}

model BlockedSlot {
  id           String   @id @default(cuid())
  tenantId     String

  date         String   // "YYYY-MM-DD"
  startTime    String   // "14:00"
  endTime      String   // "15:00"
  reason       String?  // Optional reason for blocking

  resourceId   String?  // If specific to a resource
  resource     Resource? @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())

  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([resourceId])
  @@index([date])
}

// ============ BOOKINGS ============

model Resource {
  id           String   @id @default(cuid())
  tenantId     String

  name         String   // e.g., "Marie (Coiffeuse)", "Salle 1"
  type         String   // "staff", "room", "equipment"
  color        String?  // Hex color for calendar display

  // Availability
  isActive     Boolean  @default(true)
  workingHours Json?    // Optional: specific working hours for this resource

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  availabilities  Availability[]
  blockedSlots    BlockedSlot[]
  waitingList     WaitingList[]

  @@index([tenantId])
  @@index([type])
  @@index([isActive])
}

model Booking {
  id             String   @id @default(cuid())
  tenantId       String
  conversationId String?

  // Customer info
  customerPhone  String
  customerName   String?

  // Booking details
  service        String
  date           String   // Format: YYYY-MM-DD
  time           String   // Format: HH:MM
  resourceId     String?  // Staff member, room, table, etc. for parallel bookings

  // Status lifecycle
  status         String   @default("pending") // pending, confirmed, cancelled, completed, no_show

  // Additional info
  notes          String?
  reminderSent   Boolean  @default(false)
  reminderSentAt DateTime?

  // Payment tracking (Phase 4.1)
  amount         Decimal?  @db.Decimal(10, 2) // Montant de la réservation
  currency       String?   @default("EUR")     // Devise
  paymentStatus  String    @default("unpaid")  // "unpaid", "deposit", "paid"
  paymentMethod  String?                       // "cash", "card", "transfer", "online"
  paidAt         DateTime?                     // Date du paiement

  // Recurring bookings (Phase 4.3)
  isRecurring    Boolean   @default(false)     // Est-ce une réservation récurrente
  recurrenceRule String?                       // "weekly", "biweekly", "monthly"
  recurrenceEndDate String?                    // Date de fin de récurrence (YYYY-MM-DD)
  parentBookingId String?                      // ID du booking parent si c'est une occurrence
  parentBooking  Booking?  @relation("RecurringBookings", fields: [parentBookingId], references: [id], onDelete: Cascade)
  occurrences    Booking[] @relation("RecurringBookings")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation   Conversation?  @relation(fields: [conversationId], references: [id])
  resource       Resource?      @relation(fields: [resourceId], references: [id], onDelete: SetNull)
  notifications  Notification[]

  // Prevent double booking per resource (null resourceId = single-resource business)
  @@unique([tenantId, date, time, resourceId])
  @@index([tenantId])
  @@index([date])
  @@index([status])
  @@index([customerPhone])
  @@index([resourceId])
}

// ============ WAITING LIST ============

model WaitingList {
  id             String   @id @default(cuid())
  tenantId       String

  // Customer info
  customerPhone  String
  customerName   String?

  // Desired booking details
  service        String
  desiredDate    String   // Format: YYYY-MM-DD
  desiredTime    String?  // Format: HH:MM (optional - any time that day)
  resourceId     String?  // Preferred resource

  // Status lifecycle
  status         String   @default("waiting") // "waiting", "notified", "converted", "cancelled"

  // Notifications
  notifiedAt     DateTime?
  notificationCount Int   @default(0)

  // Additional info
  notes          String?
  priority       Int      @default(0) // Higher = more priority

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resource       Resource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([status])
  @@index([desiredDate])
  @@index([resourceId])
}

// ============ CONTACTS/CRM ============

model Contact {
  id            String   @id @default(cuid())
  tenantId      String

  // Contact info
  phone         String
  name          String?
  email         String?
  company       String?

  // Segmentation
  tags          Tag[]    @relation("ContactTags")

  // Source tracking
  source        String   @default("manual") // "manual", "import", "whatsapp", "api"

  // Engagement metrics
  lastContactAt DateTime?
  messageCount  Int      @default(0)

  // Custom fields (JSON for flexibility)
  customFields  Json?

  // Opt-out status
  isOptedOut    Boolean  @default(false)
  optedOutAt    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaignRecipients CampaignRecipient[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([name])
  @@index([createdAt])
}

model Tag {
  id         String    @id @default(cuid())
  tenantId   String
  name       String
  color      String    @default("#3B82F6") // Hex color

  contacts   Contact[] @relation("ContactTags")

  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt  DateTime  @default(now())

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Segment {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  description String?

  // Dynamic filter rules (JSON)
  filterRules Json?     // e.g., {"tags": ["vip"], "lastContactAt": {"gte": "30d"}}

  // Can be static (manual) or dynamic (filter-based)
  isDynamic   Boolean   @default(false)

  contactCount Int      @default(0)

  campaigns   Campaign[]

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

// ============ MESSAGE TEMPLATES ============

model MessageTemplate {
  id           String   @id @default(cuid())
  tenantId     String

  name         String
  content      String   // Message body with {{variables}}
  category     String   @default("general") // "marketing", "utility", "authentication"

  // Variables metadata
  variables    String[] // ["name", "company", "date"]

  // WhatsApp Business API approval
  whatsappTemplateId   String?  // Meta template ID if approved
  whatsappStatus       String   @default("draft") // "draft", "pending", "approved", "rejected"
  whatsappRejectionReason String?

  // Usage tracking
  usageCount   Int      @default(0)
  lastUsedAt   DateTime?

  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaigns    Campaign[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([category])
}

// ============ CAMPAIGNS ============

model Campaign {
  id           String   @id @default(cuid())
  tenantId     String

  name         String
  description  String?

  // Status lifecycle
  status       String   @default("draft") // "draft", "scheduled", "sending", "sent", "cancelled"

  // Targeting
  segmentId    String?
  segment      Segment? @relation(fields: [segmentId], references: [id])

  // Template
  templateId   String?
  template     MessageTemplate? @relation(fields: [templateId], references: [id])

  // Custom message (if not using template)
  customMessage String?

  // Scheduling
  scheduledAt  DateTime?
  sentAt       DateTime?
  completedAt  DateTime?

  // Analytics (denormalized for performance)
  totalRecipients Int   @default(0)
  sentCount       Int   @default(0)
  deliveredCount  Int   @default(0)
  readCount       Int   @default(0)
  repliedCount    Int   @default(0)
  failedCount     Int   @default(0)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recipients   CampaignRecipient[]

  @@index([tenantId])
  @@index([status])
  @@index([scheduledAt])
}

model CampaignRecipient {
  id          String   @id @default(cuid())
  campaignId  String
  contactId   String

  // Individual status
  status      String   @default("pending") // "pending", "sent", "delivered", "read", "replied", "failed"

  // Twilio tracking
  twilioSid   String?

  // Timing
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  repliedAt   DateTime?
  failedAt    DateTime?
  failureReason String?

  // Variable values snapshot
  variableValues Json?

  // Relations
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
}

// ============ INTEGRATIONS ============

model Integration {
  id          String   @id @default(cuid())
  tenantId    String

  type        String   // "twilio", "whatsapp_business", "webhook"
  name        String

  // Connection status
  status      String   @default("disconnected") // "connected", "disconnected", "error"
  lastCheckedAt DateTime?
  lastError   String?

  // Encrypted credentials (stored securely)
  credentials Json?    // { accountSid, authToken (encrypted), etc. }

  // Configuration
  config      Json?    // { webhookUrl, phoneNumber, etc. }

  // Usage/Quota
  usageThisMonth Int   @default(0)
  usageLimit     Int?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, type])
  @@index([tenantId])
}

// ============ ANALYTICS ============

model AnalyticsDaily {
  id        String   @id @default(cuid())
  tenantId  String
  date      DateTime @db.Date

  // Conversations
  conversationsTotal     Int @default(0)
  conversationsNew       Int @default(0)
  conversationsResolved  Int @default(0)
  conversationsEscalated Int @default(0)

  // Messages
  messagesInbound  Int @default(0)
  messagesOutbound Int @default(0)
  messagesAI       Int @default(0)
  messagesHuman    Int @default(0)

  // Performance
  avgResponseTimeMs    Int?   // Average response time in milliseconds
  avgResponseTimeHuman Int?   // Human-only response time
  botResolutionRate    Float? // 0-1, percentage resolved by bot

  // Leads & Contacts
  leadsCapture   Int @default(0)
  contactsNew    Int @default(0)

  // AI Usage
  aiTier1Calls Int @default(0)
  aiTier2Calls Int @default(0)
  aiTier3Calls Int @default(0)
  aiCostEstimate Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([date])
}

model AnalyticsHourly {
  id        String   @id @default(cuid())
  tenantId  String
  timestamp DateTime // Rounded to hour

  conversationsActive Int @default(0)
  messagesInbound     Int @default(0)
  messagesOutbound    Int @default(0)

  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, timestamp])
  @@index([tenantId])
  @@index([timestamp])
}

// ============ CONVERSATION NOTES ============

model ConversationNote {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  content        String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([conversationId])
  @@index([userId])
}

// ============ NOTIFICATIONS ============

model Notification {
  id         String   @id @default(cuid())
  tenantId   String

  // Notification content
  type       String   // "new_booking", "booking_cancelled", "booking_updated", "reminder_pending", "no_show"
  title      String
  message    String

  // Linked resource
  bookingId  String?
  resourceType String? // "booking", "waiting_list", etc.
  resourceId String?

  // Status
  isRead     Boolean  @default(false)
  readAt     DateTime?

  createdAt  DateTime @default(now())

  // Relations
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  booking    Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, isRead])
  @@index([createdAt])
  @@index([bookingId])
}
